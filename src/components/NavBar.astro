---
import siteConfig from '../../site.config.mjs';
import { Home, Menu, X, Moon, Sun } from 'lucide-astro';

const title = siteConfig.title;

const menuItems = [
	{ name: 'Accueil', link: `/` },
	{ name: 'Galerie', link: `/collections` },
	{ name: 'À propos', link: `/about` },
];

const navCount = menuItems.length;
---

<nav class="nav" id="nav">
	<div
		class="relative flex h-[4rem] w-full items-center justify-between overflow-visible lg:h-[4.5rem]"
	>
		<div class="brand after:content-['']">
			<button
				id="menu-switcher"
				type="button"
				class="h-[40px] w-[44px] content-center"
			>
				<Menu
					id="menu-icon-closed"
					size={24}
					class="mx-auto hidden"
				/>
				<X
					id="menu-icon-opened"
					size={24}
					class="mx-auto hidden"
				/>
			</button>
			<a class="title" href="/">
				{title}
			</a>
		</div>
		<a class="brand-lg" href="/">
			<div class="title space-x-2">
				<Home size={32} />
				<p>{title}</p>
			</div>
		</a>
		<div class="menu">
			{
				menuItems.map((nav) => (
					<a href={nav.link}>
						<p>{nav.name}</p>
					</a>
				))
			}
		</div>
		<div class="toolbar">
			<div class="theme">
				<button type="button" id="theme-switcher">
					<Sun
						id="theme-icon-light"
						size={24}
						class="hidden"
					/>
					<Moon
						id="theme-icon-dark"
						size={24}
						class="hidden"
					/>
				</button>
			</div>
		</div>
	</div>
	<div id="mobile-menu" class="px-3 transition-all">
		<ul
			id="mobile-menu-nav"
			class="mobile-menu-nav mobile-menu-nav-closed flex flex-col space-y-6 overflow-hidden text-xl font-medium text-[var(--text-color)] transition-all duration-300"
		>
			{
				menuItems.map((nav) => (
					<li class="mt-1">
						<a href={nav.link} class="mobile-nav-item">
							<div class="flex flex-row items-center space-x-2">
								<span class="text-[var(--primary-color)]">·</span>
								<span>{nav.name}</span>
							</div>
						</a>
					</li>
				))
			}
		</ul>
	</div>
</nav>

<style define:vars={{ navCount }}>
	.nav {
		position: fixed;
		left: 50%;
		z-index: 10;
		display: flex;
		width: 100%;
		user-select: none;
		flex-direction: column;
		justify-content: flex-end;
		background-color: var(--card-color-transparent);
		padding-left: 0.625rem;
		padding-right: 0.625rem;
		opacity: 0;
		backdrop-filter: blur(12px);
		transition: all 0.3s;
		border-radius: 0 0 0.75rem 0.75rem;
		transform: translateX(-50%) translateY(-5rem);
		animation: 300ms nav-onload-animation;
		animation-fill-mode: forwards;
	}

	@media (min-width: 1024px) {
		.nav {
			width: var(--page-width-lg);
			border-radius: 0 0 1rem 1rem;
		}
	}

	@media (min-width: 1280px) {
		.nav {
			width: var(--page-width-xl);
		}
	}

	.brand {
		display: flex;
		width: 100%;
		flex-direction: row;
		align-items: center;
		justify-content: space-between;
	}

	@media (min-width: 1024px) {
		.brand {
			display: none;
		}
	}

	.brand > .title {
		position: absolute;
		left: 50%;
		top: 50%;
		transform: translateX(-50%) translateY(-50%);
		text-overflow: ellipsis;
		white-space: nowrap;
		overflow: hidden;
		border-radius: 0.5rem;
		padding-left: 1rem;
		padding-right: 1rem;
		padding-top: 0.5rem;
		padding-bottom: 0.5rem;
		font-size: 1.5rem;
		line-height: 2rem;
		font-weight: 500;
		color: var(--primary-color);
		transition: all 0.3s;
		font-family: var(--brand-font);
	}

	.brand > .title:hover {
		background-color: var(--primary-color-hover);
	}

	.brand button {
		margin-right: 0.5rem;
		display: flex;
		height: 44px;
		width: 44px;
		flex-direction: row;
		align-items: center;
		border-radius: 0.5rem;
		color: var(--text-color);
		transition: all 0.3s;
	}

	.brand button:hover {
		background-color: var(--primary-color-hover);
		color: var(--primary-color);
	}

	.brand-lg {
		display: none;
		height: 3.25rem;
		border-radius: 0.5rem;
		padding-left: 1.25rem;
		padding-right: 1.25rem;
		font-weight: 500;
		transition: all 0.3s;
	}

	.brand-lg:hover {
		background-color: var(--primary-color-hover);
	}

	.brand-lg:active {
		transform: scale(0.95);
	}

	@media (min-width: 1024px) {
		.brand-lg {
			display: block;
		}
	}

	.brand-lg > .title {
		display: flex;
		height: 100%;
		flex-direction: row;
		align-content: center;
		align-items: center;
		font-size: 1.5rem;
		line-height: 2rem;
		color: var(--primary-color);
		font-family: var(--brand-font);
	}

	.menu {
		position: absolute;
		left: 50%;
		display: none;
		transform: translateX(-50%);
		align-items: center;
		justify-content: space-between;
		gap: 0.25rem;
		font-size: 1.125rem;
		line-height: 1.75rem;
		color: var(--text-color);
		opacity: 0.85;
	}

	@media (min-width: 1024px) {
		.menu {
			display: flex;
		}
	}

	.menu a {
		display: flex;
		height: 3.25rem;
		align-items: center;
		border-radius: 0.5rem;
		padding-left: 1.5rem;
		padding-right: 1.5rem;
		transition: all 0.3s;
	}

	.menu a:hover {
		background-color: var(--primary-color-hover);
		color: var(--primary-color);
	}

	.menu a:active {
		transform: scale(0.95);
	}

	.menu p {
		font-weight: 500;
		line-height: normal;
		font-family: var(--primary-font);
	}

	.toolbar {
		display: flex;
		flex-direction: row;
		align-items: center;
		justify-content: flex-end;
		gap: 0.25rem;
	}

	@media (min-width: 1024px) {
		.toolbar {
			margin-right: 0.5rem;
		}
	}

	.toolbar button {
		display: flex;
		width: 2.75rem;
		justify-content: center;
		border-radius: 0.5rem;
		padding-top: 0.5rem;
		padding-bottom: 0.5rem;
		color: var(--text-color);
		transition: all 0.3s;
	}

	.toolbar button:hover {
		background-color: var(--primary-color-hover);
		color: var(--primary-color);
	}

	.mobile-menu-nav-closed {
		height: 0;
		opacity: 0;
	}

	.mobile-menu-nav-opened {
		opacity: 1;
		height: calc(var(--navCount) * 52px);
	}

	.mobile-menu-nav li a {
		display: flex;
		flex-direction: row;
		align-items: center;
		justify-content: space-between;
		font-family: var(--primary-font);
	}

	@keyframes nav-onload-animation {
		0% {
			transform: translateY(-5rem) translateX(-50%);
			opacity: 0;
		}
		100% {
			transform: translateY(0) translateX(-50%);
			opacity: 1;
		}
	}
</style>

<script>
	/**
	 * Reinitializes an SVG icon by cloning it and replacing the original icon with the clone.
	 *
	 * @param icon - The SVG element to be reinitialized.
	 * @returns The cloned SVG element that replaced the original.
	 */
	const reinitializeIcon = (icon: SVGElement) => {
		const cloned = icon.cloneNode(true) as SVGElement;
		icon.parentNode?.replaceChild(cloned, icon);
		return cloned;
	};

	// get elements
	const menuSwitcher = document.getElementById(
		"menu-switcher",
	) as HTMLButtonElement;
	const mobileMenuNav = document.getElementById(
		"mobile-menu-nav",
	) as HTMLUListElement;
	const mobileMenuNavItems = document.getElementsByClassName("mobile-nav-item");
	let menuIconClosed = document.getElementById(
		"menu-icon-closed",
	) as any as SVGElement;
	let menuIconOpened = document.getElementById(
		"menu-icon-opened",
	) as any as SVGElement;

	// menu state
	let isMenuOpen = false;

	// switch menu open / close
	const switchMenuState = () => {
		menuIconClosed.style.display = isMenuOpen ? "block" : "none";
		menuIconOpened.style.display = !isMenuOpen ? "block" : "none";
		if (isMenuOpen) menuIconClosed = reinitializeIcon(menuIconClosed);
		else menuIconOpened = reinitializeIcon(menuIconOpened);
		if (isMenuOpen) {
			mobileMenuNav.classList.replace(
				"mobile-menu-nav-opened",
				"mobile-menu-nav-closed",
			);
		} else {
			mobileMenuNav.classList.replace(
				"mobile-menu-nav-closed",
				"mobile-menu-nav-opened",
			);
		}
		isMenuOpen = !isMenuOpen;
	};

	// click menu item then close menu
	menuSwitcher.addEventListener("click", switchMenuState);
	for (let i = 0; i < mobileMenuNavItems.length; ++i) {
		mobileMenuNavItems.item(i)?.addEventListener("click", switchMenuState);
	}
	// click other elements then close menu
	document.addEventListener("click", (event) => {
		if (
			!menuSwitcher.contains(event.target as any) &&
			!mobileMenuNav.contains(event.target as any) &&
			isMenuOpen
		) {
			switchMenuState();
		}
	});

	// Theme switcher
	// Get elements
	const themeSwitcher = document.getElementById(
		"theme-switcher",
	) as HTMLButtonElement;
	let themeIconLight = document.getElementById(
		"theme-icon-light",
	) as any as SVGElement;
	let themeIconDark = document.getElementById(
		"theme-icon-dark",
	) as any as SVGElement;

	// Record the current theme
	let currentTheme = localStorage.getItem("theme") || "light";

	// Set theme
	const setTheme = (theme: string) => {
		document.documentElement.setAttribute("data-theme", theme);
		localStorage.setItem("theme", theme);
		currentTheme = theme;

		// Show/hide icons for different themes
		themeIconDark.style.display = theme === "dark" ? "block" : "none";
		themeIconLight.style.display = theme === "light" ? "block" : "none";

		// If the theme is dark, update the dark icon; otherwise, update the light icon
		if (theme === "dark") themeIconDark = reinitializeIcon(themeIconDark);
		else themeIconLight = reinitializeIcon(themeIconLight);

		// Toggle dark class
		document.documentElement.classList.toggle("dark", theme === "dark");
	};

	// Click to switch theme
	themeSwitcher.addEventListener("click", () => {
		setTheme(currentTheme === "light" ? "dark" : "light");
	});

	// Initialize - juste mettre à jour les icônes, le thème est déjà appliqué dans le head
	document.addEventListener("DOMContentLoaded", () => {
		// Le thème est déjà appliqué dans le head, on met juste à jour les icônes
		themeIconDark.style.display = currentTheme === "dark" ? "block" : "none";
		themeIconLight.style.display = currentTheme === "light" ? "block" : "none";
		menuIconClosed.style.display = "block";
	});

	// fold nav bar when scroll down
	const navBarElement = document.getElementById("nav");
	const bannerElement = document.getElementById("banner");
	const bannerHeight = bannerElement?.offsetHeight ? bannerElement.offsetHeight - 50 : 0;
	let lastYPos = 0;
	window.addEventListener("scroll", () => {
		if (bannerHeight < window.scrollY && window.scrollY > lastYPos) {
			navBarElement!.style.top = "-72px";
		} else {
			navBarElement!.style.top = "0";
		}
		lastYPos = window.scrollY;
	});
</script>
